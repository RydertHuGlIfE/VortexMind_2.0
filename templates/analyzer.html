<!DOCTYPE html>
<html>
  <head>
    <title>VortexMind Educator - PDF Chat Viewer</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='viewer.css') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favico.ico') }}">
  </head>
  <body>
    <header class="header">
        <div class="header-left">
            <div class="logo">
                <div class="logo-icon">ğŸ§ </div>
                <div class="logo-text">
                    <h1>VortexMind Educator</h1>
                    <p>AI Study Assistant</p>
                </div>
            </div>
        </div>

        <!-- Timer Functionality with js-->
        <div class="header-center">
            <div class="timer">
              <h1>Set a Timer: </h1>
                <label for="minutes">Minutes:</label>
                <input type="number" id="minutes"">
                <button id="strtimer">Set Timer</button>
                <button id="resettimer">Reset Timer</button>
            </div>
            <div id="Countdown" >
              <p style="margin-left: 210px;">00:00 </p>
            </div>
        </div>
        <div class="header-right">
            <div class="date-section">
                <div class="date-label">Today's Date</div>
                <div class="date-value" id="currentDate"></div>
            </div>
            <div class="user-profile">
                <div class="user-avatar">S</div>
                <div class="user-info">
                    <span class="user-name">Student</span>
                    <span class="user-tier">Premium</span>
                </div>
            </div>
            <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
                <span class="theme-icon">ğŸŒ™</span>
            </button>
        </div>
    </header>

    <div class="viewer-container">
      <div class="pdf-section">
        <div class="pdf-header">
          <h2>PDF Viewer</h2>
          <button id="backBtn" onclick="window.location.href='/'">
            â† Upload New PDF
          </button>
        </div>
        <div class="pdf-viewer">
          <iframe id="pdfFrame" src="" width="100%" height="100%"></iframe>
        </div>
      </div>

      <div class="chat-section">
        <div class="chat-header">
          <div class="header-content">
            <h2>AI Assistant</h2>
            <p>Ask me anything about your PDF!</p>
          </div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message bot-message">
            <div class="message-content">
              Hello! I've analyzed your PDF. Feel free to ask me any questions
              about its content.
            </div>
          </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
          <div class="typing-avatar">ğŸ¤–</div>
          <div class="typing-bubble">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <div class="typing-text">AI is thinking...</div>
          </div>
        </div>

        <div class="chat-input-container">
          <div class="button-row">
            <button id="summarizeBtn" class="summarize-btn">ğŸ“„ Summarize PDF</button>
            <button id="mindmapBtn" class="mindmap-btn">ğŸ§© Mind Map</button>
            <button id="quizBtn" class="quiz-btn">â“ Start Quiz</button>
            <button id="youtubeBtn" class="youtube-btn">ğŸ¥ YouTube Search</button>
          </div>

          <div id="youtubeSearch" class="youtube-search" style="display: none;">
            <div class="youtube-input-row">
              <input
                type="text"
                id="youtubeInput"
                placeholder="What do you want to search on YouTube?"
                maxlength="200"
              />
              <button id="searchBtn" class="search-btn">Search</button>
              <button id="cancelBtn" class="cancel-btn">Cancel</button>
            </div>
          </div>
          
          <div class="input-row">
            <input
              type="text"
              id="chatInput"
              placeholder="Ask a question or answer quiz here!"
              maxlength="500"
            />
            <button id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>

<script>


// timer func

const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.querySelector('.theme-icon');
const savedTheme = localStorage.getItem('theme') || 'dark';
document.body.setAttribute('data-theme', savedTheme);
updateThemeIcon(savedTheme);
themeToggle.addEventListener('click', () => {
    const currentTheme = document.body.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);

});

// --- Timer implementation (top-level) ---
let countdown = null;
const countdownEl = document.getElementById('Countdown').querySelector('p');
const minutesInputEl = document.getElementById('minutes');
const strtimerBtnEl = document.getElementById('strtimer');
const resettimerBtnEl = document.getElementById('resettimer');

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function startTimer(durationSeconds) {
  clearInterval(countdown);
  let timer = Math.max(0, Math.floor(durationSeconds));
  countdownEl.textContent = formatTime(timer);
  countdown = setInterval(() => {
    timer--;
    if (timer <= 0) {
      clearInterval(countdown);
      countdownEl.textContent = '00:00';
      alert("Time's up!");
      return;
    }
    countdownEl.textContent = formatTime(timer);
  }, 1000);
}

strtimerBtnEl.addEventListener('click', () => {
  const minutes = parseInt(minutesInputEl.value, 10);
  if (isNaN(minutes) || minutes <= 0) {
    alert('Please enter a valid number of minutes.');
    return;
  }
  startTimer(minutes * 60);
});

resettimerBtnEl.addEventListener('click', () => {
  clearInterval(countdown);
  countdownEl.textContent = '00:00';
  minutesInputEl.value = '';
});
function updateThemeIcon(theme) {
    themeIcon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
}

document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});


window.addEventListener("load", function () {
  fetch("/get-pdf-info")
    .then((response) => response.json())
    .then((data) => {
      if (data.filename) {
        document.getElementById("pdfFrame").src = "/pdf/" + data.filename;
      } else {
        window.location.href = "/";
      }
    })
    .catch((error) => {
      console.error("Error:", error);
      window.location.href = "/";
    });
});

const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const summarizeBtn = document.getElementById("summarizeBtn");
const mindmapBtn = document.getElementById("mindmapBtn");
const quizBtn = document.getElementById("quizBtn");
const youtubeBtn = document.getElementById("youtubeBtn");
const youtubeSearch = document.getElementById("youtubeSearch");
const youtubeInput = document.getElementById("youtubeInput");
const searchBtn = document.getElementById("searchBtn");
const cancelBtn = document.getElementById("cancelBtn");
const chatMessages = document.getElementById("chatMessages");
const typingIndicator = document.getElementById("typingIndicator");

function addMessage(content, isUser = false) {
  const messageDiv = document.createElement("div");
  messageDiv.className = `message ${isUser ? "user-message" : "bot-message"}`;
  const contentDiv = document.createElement("div");
  contentDiv.className = "message-content";
  contentDiv.innerHTML = content;
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTypingIndicator() {
  typingIndicator.style.display = "flex";
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTypingIndicator() {
  typingIndicator.style.display = "none";
}

function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    addMessage(message, true);
    chatInput.value = "";
    sendBtn.disabled = true;
    sendBtn.textContent = "Sending...";

    showTypingIndicator();

    if (quizBtn.dataset.active === "true") {
        fetch("/quiz/answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ answer: message }),
        })
        .then((res) => res.json())
        .then((data) => {
            if (data.all_results) {
                if(data.feedback) addMessage(`<b>Final Feedback:</b><br>${data.feedback}`);
                if(data.message) addMessage(data.message);

                let resultsHtml = '<h3>ğŸ“œ Detailed Results</h3>';
                data.all_results.forEach(item => {
                    if (item.is_correct !== undefined) {
                        const resultClass = item.is_correct ? 'correct' : 'incorrect';
                        resultsHtml += `
                            <style>
                                .result-item { border-left: 4px solid #555; padding-left: 10px; margin-bottom: 12px; }
                                .result-item.correct { border-left-color: #28a745; }
                                .result-item.incorrect { border-left-color: #dc3545; }
                            </style>
                            <div class="result-item ${resultClass}">
                                <p><strong>Q:</strong> ${item.question}</p>
                                <p>Your Answer: ${item.your_answer}</p>
                                <p>Correct Answer: ${item.correct_answer}</p>
                                <strong>Result: ${item.is_correct ? 'âœ… Correct' : 'âŒ Incorrect'}</strong>
                            </div>
                        `;
                    }
                    else if (item.evaluation) {
                         resultsHtml += `
                            <div class="result-item">
                                <p><strong>Theory Q:</strong> ${item.question}</p>
                                <p><strong>Feedback:</strong> ${item.evaluation}</p>
                            </div>
                        `;
                    }
                });
                addMessage(resultsHtml);

                quizBtn.dataset.active = "false";
            
            } else {
                if (data.result && data.result.is_correct !== undefined) {
                    const feedbackMsg = data.result.is_correct ? 'âœ… Correct!' : `âŒ Incorrect. The right answer was <strong>${data.result.correct_answer}</strong>.`;
                    addMessage(feedbackMsg);
                }
                 if(data.message) addMessage(data.message);
                 if (data.feedback) addMessage(`<b>Feedback:</b><br>${data.feedback}`);

                if (data.next_question) {
                     if (data.options) {
                         addMessage(`<b>Next Question:</b> ${data.next_question}<br><i>Options: ${data.options.join(", ")}</i>`);
                     } else {
                         addMessage(`<b>Next Theory Question:</b> ${data.next_question}`);
                     }
                }
            }
        })
        .catch((err) => addMessage("Error: " + err))
        .finally(() => {
            hideTypingIndicator();
            sendBtn.disabled = false;
            sendBtn.textContent = "Send";
        });
    } else {
        fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message }),
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.response) {
                addMessage(data.response);
            } else {
                addMessage("Sorry, I encountered an error. Please try again.");
            }
        })
        .catch((error) => {
            console.error("Error:", error);
            addMessage("Sorry, I encountered an error. Please try again.");
        })
        .finally(() => {
            hideTypingIndicator();
            sendBtn.disabled = false;
            sendBtn.textContent = "Send";
        });
    }
}

function summarizePDF() {
  addMessage("Summarize this PDF", true);
  summarizeBtn.disabled = true;
  summarizeBtn.textContent = "Summarizing...";
  showTypingIndicator();
  fetch("/summarize", { method: "POST", headers: { "Content-Type": "application/json" }})
    .then((res) => res.json())
    .then((data) => addMessage(data.response || "Error while summarizing."))
    .catch((err) => addMessage("Error: " + err))
    .finally(() => {
      hideTypingIndicator();
      summarizeBtn.disabled = false;
      summarizeBtn.textContent = "ğŸ“„ Summarize PDF";
    });
}

function mindmap() {
  addMessage("Create a Mindmap for this PDF", true);
  mindmapBtn.disabled = true;
  mindmapBtn.textContent = "Generating..";
  showTypingIndicator();
  fetch("/mindmap", { method: "POST", headers: { "Content-Type": "application/json" }})
    .then((res) => res.json())
    .then((data) => addMessage(data.response || "Error creating Mind Map."))
    .catch((err) => addMessage("Error: " + err))
    .finally(() => {
      hideTypingIndicator();
      mindmapBtn.disabled = false;
      mindmapBtn.textContent = "ğŸ§© Mind Map";
    });
}

function startQuiz() {
  addMessage("Starting Quiz...", true);
  quizBtn.disabled = true;
  quizBtn.textContent = "Starting...";
  showTypingIndicator();
  fetch("/quiz/start", { method: "POST", headers: { "Content-Type": "application/json" }})
    .then((res) => res.json())
    .then((data) => {
      if (data.question) {
        quizBtn.dataset.active = "true";
        addMessage(`<b>First Question:</b> ${data.question} <br>Options: ${data.options.join(", ")}`);
      } else {
        addMessage("Error starting quiz.");
      }
    })
    .catch((err) => addMessage("Error: " + err))
    .finally(() => {
      hideTypingIndicator();
      quizBtn.disabled = false;
      quizBtn.textContent = "â“ Start Quiz";
    });
}

function showYouTubeSearch() {
  youtubeSearch.style.display = "block";
  youtubeInput.focus();
}
function hideYouTubeSearch() {
  youtubeSearch.style.display = "none";
  youtubeInput.value = "";
}
function searchYouTube() {
  const searchQuery = youtubeInput.value.trim();
  if (!searchQuery) return;
  addMessage(`Searching YouTube for: ${searchQuery}`, true);
  fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message: `search youtube for: ${searchQuery}` }),
  })
    .then((res) => res.json())
    .then((data) => addMessage(data.response || "YouTube search opened in browser!"))
    .catch(() => addMessage("YouTube search opened in browser!"));
  hideYouTubeSearch();
}

sendBtn.addEventListener("click", sendMessage);
summarizeBtn.addEventListener("click", summarizePDF);
mindmapBtn.addEventListener("click", mindmap);
quizBtn.addEventListener("click", startQuiz);
youtubeBtn.addEventListener("click", showYouTubeSearch);
searchBtn.addEventListener("click", searchYouTube);
cancelBtn.addEventListener("click", hideYouTubeSearch);
chatInput.addEventListener("keypress", function (e) {
  if (e.key === "Enter") {
    sendMessage();
  }
});
youtubeInput.addEventListener("keypress", function (e) {
  if (e.key === "Enter") searchYouTube();
  if (e.key === "Escape") hideYouTubeSearch();
});

</script>
  </body>
</html>
